---
# tasks file for rsyslog_server

- name: Rsyslog Server | Install rsyslog
  yum:
    name: rsyslog

- name: Rsyslog Server | start and enable rsyslog
  service:
    name: rsyslog
    state: started
    enabled: yes

- name: Rsyslog Server | Open port for audit logs
  lineinfile: 
    path: /etc/audit/auditd.conf
    regexp: '^#tcp_listen_port = 60'
    line: 'tcp_listen_port = 60'

- name: Rsyslog Server | Enable UDP im module
  lineinfile: 
    path: /etc/rsyslog.conf
    regexp: '^#$ModLoad imudp'
    line: '$ModLoad imudp'

- name: Rsyslog Server | UDP port for rsyslog
  lineinfile: 
    path: /etc/rsyslog.conf
    regexp: '^#$UDPServerRun 514'
    line: '$UDPServerRun 514'

- name: Rsyslog Server | Enable TCP im module
  lineinfile:
    path: /etc/rsyslog.conf
    regexp: '^#$ModLoad imtcp/'
    line: '$ModLoad imtcp/'

- name: Rsyslog Server | TCP port for rsyslog
  lineinfile: 
    path: /etc/rsyslog.conf
    regexp: '^#$InputTCPServerRun 514'
    line: '#$InputTCPServerRun 514'

- name: Rsyslog Server | define files for remote service
  blockinfile:
    path: /etc/rsyslog.conf
    insertafter: EOF
    block: |
      if $fromhost-ip contains '192.168.50.10' then /var/log/wordpress.log
      if $fromhost-ip contains '192.168.50.12' then /var/log/zabbix.log

- name: Rsyslog Server | Restart auditd
  command: >
    service auditd restart

- name: Rsyslog Server | Restart rsyslog
  service:
    name: rsyslog
    state: restarted 
 
- name: Rsyslog Server | open tcp port
  firewalld:
    port: 514/tcp
    permanent: true
    state: enabled
    immediate: yes

- name: Rsyslog Server | open udp port
  firewalld:
    port: 514/udp
    permanent: true
    state: enabled
    immediate: yes
 
- name: Rsyslog Server | install httpd and php for LogAnalyzer
  yum:
    name: ['httpd', 'php']
    state: present

- name: Ryslog Server | download LogAnalyzer
  get_url:
    url: http://download.adiscon.com/loganalyzer/loganalyzer-4.1.11.tar.gz
    dest: /home/vagrant/log.tar.gz
    checksum: md5:46f3113b4efb552564a4a8eaac12f0af

- name: Rsyslog Server | mkdir for extract logAnalyzer
  file:
    path: /home/vagrant/log
    state: directory

- name: Rsyslog Server | untar LogAnalyzer tar
  unarchive:
    src: /home/vagrant/log.tar.gz
    dest: /home/vagrant/log
    extra_opts: [--strip-components=1]
    remote_src: yes

- name: Rsyslog Server | mkdir for LogAnalyzer www
  file:
    path: /var/www/html/log
    state: directory
    owner: apache
    group: apache

- name: Rsyslog Server | copy LogAnalyzer to www dir
  copy:
    src: /home/vagrant/log/src/
    dest: /var/www/html/log/
    remote_src: yes

- name: Rsyslog Server | Open 80 port for httpd
  firewalld:
    port: 80/tcp
    permanent: true
    state: enabled
    immediate: yes
